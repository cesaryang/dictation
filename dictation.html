<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Dictation Online</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #wordInput { font-size: 1.2em; }
        #result { margin-top: 10px; font-size: 1.2em; }
        .correct { color: green; }
        .wrong { color: red; }
        #summary { margin-top: 20px; font-size: 1.1em; }
        #startBtn { font-size: 1em; padding: 6px 16px; }
        table { border-collapse: collapse; } /* 移除 width: 100%; */
        th, td { padding: 8px 12px; text-align: left; border: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        /* 减小错误单词列表的字号 */
        #wrongList {
            margin-top: 20px;
            color: #b22222;
            font-size: 0.9em; /* 或者使用 'small' */
        }
    </style>
</head>
<body>
    <h2>Dictation Online</h2>
    
    
    <!-- 成功提示区域 -->
    <div id="successMessage" style="display: none; margin-bottom: 10px; padding: 10px; border-radius: 5px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;">
    </div>
    
    <!-- 错误警告区域 -->
    <div id="errorMessage" style="display: none; margin-bottom: 10px; padding: 10px; border-radius: 5px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
    </div>

    <div>
        <button id="startBtn" disabled>开始背词</button>
    </div>
    
    <!-- GitHub配置面板 -->
    <div id="configPanel" style="margin-top: 15px; padding: 15px; border: 2px solid #007bff; border-radius: 8px; background-color: #f8f9ff; display: none;">
        <h3 style="margin-top: 0; color: #007bff;">GitHub配置</h3>
        <div style="margin-bottom: 10px;">
            <label for="tokenInput" style="display: block; margin-bottom: 5px; font-weight: bold;">GitHub Token:</label>
            <input type="text" id="tokenInput" placeholder="输入您的GitHub Personal Access Token" style="width: 400px; padding: 8px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
            <label for="gistIdInput" style="display: block; margin-bottom: 5px; font-weight: bold;">Gist ID:</label>
            <input type="text" id="gistIdInput" placeholder="输入您的Gist ID" style="width: 400px; padding: 8px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 10px;">
            <button id="saveConfigBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">保存配置</button>
            <button id="testConfigBtn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">测试连接</button>
        </div>
        <div style="font-size: 0.85em; color: #666;">
            <p style="margin: 5px 0;">• Token将以混淆方式保存在浏览器本地存储中</p>
            <p style="margin: 5px 0;">• 如需获取Token，请访问GitHub Settings → Developer settings → Personal access tokens</p>
        </div>
    </div>
    
    <!-- 添加新词功能 (折叠式) -->
    <div style="margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f0f8ff;">
        <div>
            <button id="toggleAddWordBtn" style="background: none; border: none; cursor: pointer; font-size: 1.1em; color: #007bff;">
                <span id="toggleIcon">▶</span> 添加新词
            </button>
        </div>
        <div id="addWordPanel" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
            <div style="margin-bottom: 10px;">
                <input type="text" id="newWordInput" placeholder="输入要添加的新单词" style="width: 250px; font-size: 1.1em;">
                <button id="addWordBtn">添加单词</button>
                <button id="testNewWordBtn" style="margin-left: 10px;">测试发音</button>
            </div>
            <div style="font-size: 0.9em; color: #666;">
                提示：添加后单词会自动保存到当前单词列表中
            </div>
        </div>
    </div>
    <div id="dictationArea" style="margin-top:20px; display:none;">
        <span>请输入你听到的单词：</span>
        <input type="text" id="wordInput" autocomplete="off">
        <button id="repeatBtn" type="button">重听</button>
        <div id="result"></div>
    </div>
    <div id="summary"></div>
    <!-- 在 summary 下方增加一个错误单词列表的显示区域 -->
    <div id="wrongList" style="margin-top:20px; color:#b22222;"></div>

    <script>
let words = []; // 存储从文件加载的原始单词列表
let shuffledWords = []; // 存储当前轮次需要听写的单词
let masteredWordsInTest = []; // 存储当前测试中的已掌握单词
let current = 0;
let isStarted = false;
let wrongWords = []; // 存储当天听写错误的单词
const synth = window.speechSynthesis;

// 新增：存储每个单词的连续正确次数
let correctStreaks = {};
// 如何查看已背正确次数：打开浏览器开发者工具 (通常按 F12)，切换到 Console (控制台) 标签页，输入 correctStreaks 并按 Enter 即可查看每个单词的连续正确次数。

// 新增：存储当天总尝试次数
let todayAttempts = 0;
// 新增：存储当天尝试过的唯一单词
let todayAttemptedWords = new Set();

// GitHub Gist 配置和功能
let githubConfig = {
    token: '',
    gistId: ''
};

// 简单混淆函数（Base64+字符替换）
function obfuscate(str) {
    return btoa(str).split('').map(c => String.fromCharCode(c.charCodeAt(0) + 1)).join('');
}

function deobfuscate(str) {
    return atob(str.split('').map(c => String.fromCharCode(c.charCodeAt(0) - 1)).join(''));
}

// 保存配置到localStorage（混淆保护）
function saveGitHubConfig(token, gistId) {
    try {
        const config = {
            token: obfuscate(token),
            gistId: gistId, // gistId不需要混淆，是公开信息
            timestamp: Date.now()
        };
        localStorage.setItem('dictation_github_config', JSON.stringify(config));
        console.log('GitHub配置已保存');
        return true;
    } catch (error) {
        console.error('保存GitHub配置失败:', error);
        return false;
    }
}

// 从localStorage加载配置（解混淆）
function loadGitHubConfig() {
    try {
        const configStr = localStorage.getItem('dictation_github_config');
        if (!configStr) return null;
        
        const config = JSON.parse(configStr);
        return {
            token: deobfuscate(config.token),
            gistId: config.gistId,
            timestamp: config.timestamp
        };
    } catch (error) {
        console.error('读取GitHub配置失败:', error);
        return null;
    }
}

// 检查是否已有有效配置
function hasValidConfig() {
    const config = loadGitHubConfig();
    return config && config.token && config.gistId;
}

// 已掌握的单词列表（连续7次正确后移入此列表）
let masteredWords = [];

// 获取需要重新测试的已掌握单词（每5天测试一次）
function getMasteredWordsDueForTesting() {
    const today = new Date();
    const dueDays = 5; // 每5天测试一次
    
    return masteredWords.filter(item => {
        if (!item.lastTestDate) {
            // 如果没有lastTestDate，使用masteredDate作为初始测试日期
            item.lastTestDate = item.masteredDate;
        }
        
        const lastTestDate = new Date(item.lastTestDate);
        const daysSinceLastTest = Math.floor((today - lastTestDate) / (1000 * 60 * 60 * 24));
        
        return daysSinceLastTest >= dueDays;
    }).map(item => item.word);
}

// 清理超过3天的历史记录
function cleanOldHistoryData(historyData) {
    if (!historyData) return {};
    
    const today = new Date();
    const threeDaysAgo = new Date(today);
    threeDaysAgo.setDate(today.getDate() - 3);
    
    const cleanedData = {};
    
    for (const dateStr in historyData) {
        // 解析日期 (YYYY-MM-DD 或 YYYY-M-D 格式)
        const dateParts = dateStr.split('-');
        if (dateParts.length === 3) {
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1; // JS月份从0开始
            const day = parseInt(dateParts[2]);
            const recordDate = new Date(year, month, day);
            
            // 保留3天内的记录
            if (recordDate >= threeDaysAgo) {
                cleanedData[dateStr] = historyData[dateStr];
            } else {
                console.log(`删除过期记录: ${dateStr}`);
            }
        }
    }
    
    return cleanedData;
}

// 清理本地localStorage中的过期历史数据
function cleanLocalStorageHistory() {
    const today = new Date();
    const threeDaysAgo = new Date(today);
    threeDaysAgo.setDate(today.getDate() - 3);
    
    const keysToDelete = [];
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.startsWith('dictation_done_') || 
                   key.startsWith('dictation_wrong_') || 
                   key.startsWith('dictation_attempts_') ||
                   key.startsWith('dictation_attempted_'))) {
            
            const dateMatch = key.match(/_(\d{4}-\d+-\d+)$/);
            if (dateMatch) {
                const dateStr = dateMatch[1];
                const dateParts = dateStr.split('-');
                if (dateParts.length === 3) {
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const day = parseInt(dateParts[2]);
                    const recordDate = new Date(year, month, day);
                    
                    // 标记超过3天的记录为待删除
                    if (recordDate < threeDaysAgo) {
                        keysToDelete.push(key);
                    }
                }
            }
        }
    }
    
    // 删除过期的localStorage项
    keysToDelete.forEach(key => {
        console.log(`清理本地过期数据: ${key}`);
        localStorage.removeItem(key);
    });
    
    if (keysToDelete.length > 0) {
        console.log(`已清理 ${keysToDelete.length} 条本地过期记录`);
    }
}

// GitHub Gist API 功能
async function saveToGist(data) {
    if (!githubConfig.token) {
        throw new Error('GitHub token 未配置');
    }

    // 清理历史数据（保留3天内的记录）
    const cleanedHistoryData = cleanOldHistoryData(data.historyData || {});
    
    const gistData = {
        description: "单词听写数据",
        public: false,
        files: {
            "words.txt": {
                content: data.words.join('\n')
            },
            "data.json": {
                content: JSON.stringify({
                    correctStreaks: data.correctStreaks || {},
                    masteredWords: data.masteredWords || [],
                    todayRecords: {
                        date: getTodayStr(),
                        doneWords: data.todayDoneWords || [],
                        wrongWords: data.todayWrongWords || [],
                        attempts: data.todayAttempts || 0,
                        attemptedWords: Array.from(data.todayAttemptedWords || [])
                    },
                    historyData: cleanedHistoryData
                }, null, 2)
            }
        }
    };

    let url = githubConfig.gistId 
        ? `https://api.github.com/gists/${githubConfig.gistId}`
        : 'https://api.github.com/gists';
    
    let method = githubConfig.gistId ? 'PATCH' : 'POST';

    let response = await fetch(url, {
        method: method,
        headers: {
            'Authorization': `token ${githubConfig.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(gistData)
    });

    // 如果是404错误（Gist不存在），则创建新的Gist
    if (response.status === 404 && githubConfig.gistId) {
        console.log('原Gist不存在，创建新的Gist...');
        url = 'https://api.github.com/gists';
        method = 'POST';
        
        response = await fetch(url, {
            method: method,
            headers: {
                'Authorization': `token ${githubConfig.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gistData)
        });
    }

    if (!response.ok) {
        const errorText = await response.text();
        console.error('GitHub API 错误详情:', {
            status: response.status,
            statusText: response.statusText,
            url: url,
            method: method,
            response: errorText
        });
        throw new Error(`GitHub API 错误: ${response.status} ${response.statusText}\n详情: ${errorText}`);
    }

    const result = await response.json();
    
    // 如果是新创建的Gist，更新ID并记录
    if (method === 'POST') {
        const oldGistId = githubConfig.gistId;
        githubConfig.gistId = result.id;
        console.log('新创建的 Gist ID:', result.id);
        
        if (oldGistId) {
            console.log(`原Gist不存在，已创建新的 Gist，ID: ${result.id}`);
        } else {
            console.log(`已创建新的 Gist，ID: ${result.id}`);
        }
    }
    
    return result;
}

async function loadFromGist() {
    if (!githubConfig.token || !githubConfig.gistId) {
        throw new Error('GitHub 配置不完整');
    }

    const response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
        headers: {
            'Authorization': `token ${githubConfig.token}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });

    if (!response.ok) {
        const errorText = await response.text();
        console.error('加载Gist失败:', {
            status: response.status,
            statusText: response.statusText,
            gistId: githubConfig.gistId,
            response: errorText
        });
        throw new Error(`GitHub API 错误: ${response.status} ${response.statusText}\n详情: ${errorText}`);
    }

    const gist = await response.json();
    
    const result = {
        words: [],
        correctStreaks: {},
        masteredWords: [],
        todayDoneWords: [],
        todayWrongWords: [],
        todayAttempts: 0,
        todayAttemptedWords: []
    };

    // 解析单词列表
    if (gist.files['words.txt']) {
        result.words = gist.files['words.txt'].content
            .split(/\r?\n/)
            .map(w => w.trim())
            .filter(w => w.length > 0);
    }

    // 解析数据
    if (gist.files['data.json']) {
        try {
            const data = JSON.parse(gist.files['data.json'].content);
            result.correctStreaks = data.correctStreaks || {};
            result.masteredWords = data.masteredWords || [];
            
            // 检查是否是今天的记录
            if (data.todayRecords && data.todayRecords.date === getTodayStr()) {
                result.todayDoneWords = data.todayRecords.doneWords || [];
                result.todayWrongWords = data.todayRecords.wrongWords || [];
                result.todayAttempts = data.todayRecords.attempts || 0;
                result.todayAttemptedWords = data.todayRecords.attemptedWords || [];
            }
            
            // 处理历史数据，清理过期记录
            if (data.historyData) {
                const cleanedHistoryData = cleanOldHistoryData(data.historyData);
                
                // 同步清理本地localStorage中的过期数据
                cleanLocalStorageHistory();
                
                // 将清理后的历史数据同步到localStorage
                for (const date in cleanedHistoryData) {
                    const record = cleanedHistoryData[date];
                    if (record.doneWords) {
                        localStorage.setItem(`dictation_done_${date}`, JSON.stringify(record.doneWords));
                    }
                    if (record.wrongWords) {
                        localStorage.setItem(`dictation_wrong_${date}`, JSON.stringify(record.wrongWords));
                    }
                    if (record.attempts !== undefined) {
                        localStorage.setItem(`dictation_attempts_${date}`, JSON.stringify(record.attempts));
                    }
                    if (record.attemptedWords) {
                        localStorage.setItem(`dictation_attempted_${date}`, JSON.stringify(record.attemptedWords));
                    }
                }
            }
        } catch (e) {
            console.error('解析 data.json 失败:', e);
        }
    }

    return result;
}


// 新增：保存连续正确次数到 localStorage
function saveStreaks() {
    localStorage.setItem('dictation_streaks', JSON.stringify(correctStreaks));
}

// 新增：保存当前剩余单词列表到 localStorage
function saveWords() {
    localStorage.setItem('dictation_words', JSON.stringify(words));
}

// 新增：保存当天总尝试次数
function saveTodayAttempts(attempts) {
    const key = "dictation_attempts_" + getTodayStr();
    localStorage.setItem(key, JSON.stringify(attempts));
}

// 新增：获取当天总尝试次数
function getTodayAttempts() {
    const key = "dictation_attempts_" + getTodayStr();
    const val = localStorage.getItem(key);
    return val ? JSON.parse(val) : 0; // 如果没有记录，默认为0
}

// 获取当天日期字符串 (凌晨4点为分界线)
function getTodayStr() {
    const now = new Date();
    const hour = now.getHours();
    const date = new Date(now); // 创建一个副本，避免修改原始 now 对象

    // 如果当前时间在凌晨0点到4点之间，则视为前一天
    if (hour < 4) {
        date.setDate(date.getDate() - 1);
    }

    const year = date.getFullYear();
    const month = date.getMonth() + 1; // 月份从0开始，需要加1
    const day = date.getDate();

    // 格式化为 YYYY-MM-DD
    return `${year}-${month}-${day}`;
}

// 获取当天已背单词
function getTodayDoneWords() {
    const key = "dictation_done_" + getTodayStr();
    const val = localStorage.getItem(key);
    return val ? JSON.parse(val) : [];
}

// 保存当天已背单词
function saveTodayDoneWords(doneWords) {
    const key = "dictation_done_" + getTodayStr();
    localStorage.setItem(key, JSON.stringify(doneWords));
}

function saveTodayWrongWords(wrongWords) {
    const key = "dictation_wrong_" + getTodayStr();
    localStorage.setItem(key, JSON.stringify(wrongWords));
}

function getTodayWrongWords() {
    const key = "dictation_wrong_" + getTodayStr();
    const val = localStorage.getItem(key);
    return val ? JSON.parse(val) : [];
}

// 添加新的存取函数
function saveTodayAttemptedWords() {
    const key = "dictation_attempted_" + getTodayStr();
    localStorage.setItem(key, JSON.stringify(Array.from(todayAttemptedWords)));
}

function getTodayAttemptedWords() {
    const key = "dictation_attempted_" + getTodayStr();
    const val = localStorage.getItem(key);
    return new Set(val ? JSON.parse(val) : []);
}


function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function speakWord(word) {
    if (synth.speaking) {
        synth.cancel();
    }

    const voices = synth.getVoices();
    if (voices.length === 0) {
        // Voices are loaded asynchronously. Wait for them and retry.
        synth.onvoiceschanged = () => speakWord(word);
        return;
    }

    const voice = voices.find(v => v.name.includes('Google US English')) || voices.find(v => v.lang.startsWith('en-US')) || voices[0];
    
    const utter = new SpeechSynthesisUtterance(word);
    utter.lang = 'en-US';
    if (voice) {
        utter.voice = voice;
    }
    utter.rate = 1.0;
    utter.onerror = (event) => console.error("Speech synthesis error:", event.error);

    synth.speak(utter);
}

// 新增：预加载单词发音
function preloadAudio(wordList) {
    const voices = synth.getVoices();
    const voice = voices.find(v => v.name.includes('Google US English')) || voices[0]; // 使用相同的语音
    wordList.forEach(word => {
        const utter = new SpeechSynthesisUtterance(word);
        utter.lang = 'en-US';
        if (voice) utter.voice = voice;
        utter.volume = 0; // 设置音量为0，进行预加载
        // 浏览器会自动将这些utterance加入队列并处理
        synth.speak(utter);
    });
    console.log(`尝试预加载 ${wordList.length} 个单词的发音...`); // 可选：在控制台输出提示
}


// 比较用户输入和正确单词，返回带有红色标记的HTML
function highlightIncorrectLetters(userInput, correctWord) {
    if (!userInput || !correctWord) return userInput || '';
    
    let result = '';
    const maxLength = Math.max(userInput.length, correctWord.length);
    
    for (let i = 0; i < maxLength; i++) {
        const userChar = userInput[i] || '';
        const correctChar = correctWord[i] || '';
        
        if (i < userInput.length) {
            if (userChar.toLowerCase() === correctChar.toLowerCase()) {
                result += userChar;
            } else {
                result += `<span style="color: red; font-weight: bold;">${userChar}</span>`;
            }
        }
    }
    
    return result;
}

// 新的智能错误标注函数：返回用户输入和正确单词的标注结果
function getErrorHighlighting(userInput, correctWord) {
    if (!correctWord) return { userHighlight: userInput || '', correctHighlight: '' };
    
    // 特殊情况1：空输入 - 正确单词全部标红
    if (!userInput || userInput.trim() === '') {
        return {
            userHighlight: '<em>（空输入）</em>',
            correctHighlight: `<span style="color: red; font-weight: bold; background-color: #ffeeee;">${correctWord}</span>`
        };
    }
    
    const user = userInput.toLowerCase();
    const correct = correctWord.toLowerCase();
    
    // 使用简单的编辑距离算法来找到最佳对齐
    const alignment = findBestAlignment(user, correct);
    
    let correctResult = '';
    let userResult = '';
    let correctIndex = 0;
    let userIndex = 0;
    
    for (const operation of alignment) {
        if (operation.type === 'match') {
            // 匹配的字符，正常显示
            correctResult += correctWord[correctIndex];
            userResult += userInput[userIndex];
            correctIndex++;
            userIndex++;
        } else if (operation.type === 'substitute') {
            // 替换错误，在正确字符上标注红色
            correctResult += `<span style="color: red; font-weight: bold; background-color: #ffeeee;">${correctWord[correctIndex]}</span>`;
            userResult += `<span style="color: red; font-weight: bold;">${userInput[userIndex]}</span>`;
            correctIndex++;
            userIndex++;
        } else if (operation.type === 'insert') {
            // 遗漏的字符，在正确位置标注红色
            correctResult += `<span style="color: red; font-weight: bold; background-color: #ffeeee;">${correctWord[correctIndex]}</span>`;
            correctIndex++;
        } else if (operation.type === 'delete') {
            // 用户多输入的字符，在用户输入中标注红色
            userResult += `<span style="color: red; font-weight: bold; background-color: #ffeeee;">${userInput[userIndex]}</span>`;
            userIndex++;
        }
    }
    
    return {
        userHighlight: userResult,
        correctHighlight: correctResult
    };
}

// 找到最佳对齐的简化算法
function findBestAlignment(user, correct) {
    const m = user.length;
    const n = correct.length;
    
    // 动态规划矩阵
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    const operations = Array(m + 1).fill(null).map(() => Array(n + 1).fill(''));
    
    // 初始化边界
    for (let i = 0; i <= m; i++) {
        dp[i][0] = i;
        operations[i][0] = 'delete';
    }
    for (let j = 0; j <= n; j++) {
        dp[0][j] = j;
        operations[0][j] = 'insert';
    }
    
    // 填充矩阵
    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (user[i-1] === correct[j-1]) {
                dp[i][j] = dp[i-1][j-1];
                operations[i][j] = 'match';
            } else {
                const substitute = dp[i-1][j-1] + 1;
                const insert = dp[i][j-1] + 1;
                const del = dp[i-1][j] + 1;
                
                if (substitute <= insert && substitute <= del) {
                    dp[i][j] = substitute;
                    operations[i][j] = 'substitute';
                } else if (insert <= del) {
                    dp[i][j] = insert;
                    operations[i][j] = 'insert';
                } else {
                    dp[i][j] = del;
                    operations[i][j] = 'delete';
                }
            }
        }
    }
    
    // 回溯找到操作序列
    const alignment = [];
    let i = m, j = n;
    
    while (i > 0 || j > 0) {
        const op = operations[i][j];
        alignment.unshift({ type: op });
        
        if (op === 'match' || op === 'substitute') {
            i--; j--;
        } else if (op === 'insert') {
            j--;
        } else if (op === 'delete') {
            i--;
        }
    }
    
    return alignment;
}

function updateSummary() {
    const wrongCount = wrongWords.length;
    const uniqueWordsCount = todayAttemptedWords.size;
    const correctCount = Math.max(0, todayAttempts - wrongCount);

    document.getElementById('summary').textContent =
        `今天已背 ${uniqueWordsCount} 个单词，正确 ${correctCount} 次，错误 ${wrongCount} 次。`;
    // 更新错误单词列表
    let html = '';
    if (wrongWords.length > 0) {
        html = '<b>拼写错误列表：</b>';
        // 使用 flexbox 容器让两个表格并排显示，移除 gap
        html += '<div style="display: flex; margin-top: 10px;">'; // 移除 gap: 20px;

        // 第一个表格：显示你的输入，标注错误
        html += '<div>';
        html += '<table border="1" style="border-collapse: collapse;">';
        html += '<tr><th>你的输入</th></tr>'; // 表头
        for (const item of wrongWords) {
            const highlighting = getErrorHighlighting(item.input, item.word);
            html += `<tr><td>${highlighting.userHighlight}</td></tr>`;
        }
        html += '</table>';
        html += '</div>';

        // 第二个表格：显示正确拼写，标注错误位置
        html += '<div>';
        html += '<table border="1" style="border-collapse: collapse;">';
        html += '<tr><th>正确拼写</th></tr>'; // 表头
        for (const item of wrongWords) {
            const highlighting = getErrorHighlighting(item.input, item.word);
            html += `<tr><td>${highlighting.correctHighlight}</td></tr>`;
        }
        html += '</table>';
        html += '</div>';

        html += '</div>'; // 关闭 flex 容器
    }
    document.getElementById('wrongList').innerHTML = html;
}

function startDictation() {
    // 过滤掉当天已背过的单词
    const doneWords = getTodayDoneWords();
    // 使用当前words列表进行过滤
    let regularWords = words.filter(w => !doneWords.includes(w));
    
    // 获取需要重新测试的已掌握单词
    const masteredWordsForTesting = getMasteredWordsDueForTesting();
    masteredWordsInTest = [...masteredWordsForTesting]; // 保存已掌握单词列表用于后续处理
    
    // 合并常规单词和需要测试的已掌握单词
    shuffledWords = [...regularWords, ...masteredWordsForTesting];
    shuffle(shuffledWords);
    current = 0;
    // total = 0; // 移除此行
    // correct = 0; // 移除此行
    // 不要清空 wrongWords
    // wrongWords = [];
    isStarted = true;
    document.getElementById('dictationArea').style.display = '';
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('result').textContent = '';
    document.getElementById('wordInput').value = '';
    document.getElementById('wordInput').focus();

    // 在开始听写时加载当天的尝试次数和错误列表
    wrongWords = getTodayWrongWords();
    todayAttempts = getTodayAttempts();
    todayAttemptedWords = getTodayAttemptedWords();

    updateSummary(); // 更新显示

    if (shuffledWords.length === 0) {
        document.getElementById('result').innerHTML = '<span class="correct">今天的单词都已背过！</span>';
        setTimeout(endDictation, 2000);
    } else {
        // 显示测试信息
        const masteredCount = masteredWordsForTesting.length;
        const regularCount = regularWords.length;
        if (masteredCount > 0) {
            const infoText = `本次测试包含：${regularCount} 个常规单词，${masteredCount} 个已掌握单词复习`;
            document.getElementById('summary').textContent += ` ${infoText}`;
        }
        nextWord();
    }
}

function nextWord() {
    if (current < shuffledWords.length) {
        // 先播放发音
        speakWord(shuffledWords[current]);
        // 再清除输入框内容
        document.getElementById('wordInput').value = '';
        document.getElementById('wordInput').focus();
    } else {
        endDictation();
    }
}

function submitAnswer() {
    if (!isStarted) return;
    const input = document.getElementById('wordInput').value.trim().toLowerCase();
    const answer = shuffledWords[current].toLowerCase();
    const word = shuffledWords[current];

    // 记录尝试过的唯一单词
    todayAttemptedWords.add(word);
    saveTodayAttemptedWords();

    // 每次提交答案，总尝试次数加一
    todayAttempts++;
    saveTodayAttempts(todayAttempts);

    let doneWords = getTodayDoneWords();

    if (input === answer) {
        document.getElementById('result').innerHTML = '<span class="correct">正确！</span>';
        
        // 检查是否是已掌握单词的重新测试
        if (masteredWordsInTest.includes(word)) {
            // 已掌握单词测试正确，更新最后测试日期
            const masteredWordItem = masteredWords.find(item => item.word === word);
            if (masteredWordItem) {
                masteredWordItem.lastTestDate = new Date().toISOString().split('T')[0];
                document.getElementById('result').innerHTML += '<span style="color:blue;">（已掌握单词复习正确）</span>';
            }
        } else {
            // 常规单词的连续正确计数逻辑
            correctStreaks[word] = (correctStreaks[word] || 0) + 1;
            saveStreaks(); // 保存 streak 变化

            if (correctStreaks[word] >= 7) { // 修改为7次
                // 连续正确达到7次，将单词移入已掌握列表
                masteredWords.push({
                    word: word,
                    masteredDate: new Date().toISOString().split('T')[0], // YYYY-MM-DD 格式
                    lastTestDate: new Date().toISOString().split('T')[0] // 记录最后测试日期
                });
                
                // 从当前学习列表中移除该单词
                words = words.filter(w => w !== word);
                saveWords(); // 保存更新后的 words 列表

                // 从 streak 记录中移除该单词，保持记录干净
                delete correctStreaks[word];
                saveStreaks(); // 保存更新后的 streak 记录

                document.getElementById('result').innerHTML += `<span style="color:blue;">（连续7次正确，已掌握）</span>`;

                current++;
                setTimeout(() => {
                    if (current < shuffledWords.length) {
                        nextWord();
                    } else {
                        endDictation();
                    }
                }, 600);
                return;
            }
        }

        // 如果这个单词是第一次正确，才加入 doneWords
        if (!doneWords.includes(word)) {
            doneWords.push(word);
            saveTodayDoneWords(doneWords);
        }
    } else {
        const highlighting = getErrorHighlighting(input, word);
        document.getElementById('result').innerHTML =
            `<span class="wrong">错误</span>，你的输入：<b>${highlighting.userHighlight}</b>，正确拼写：<b>${highlighting.correctHighlight}</b>`;
        wrongWords.push({input: input, word: word});
        saveTodayWrongWords(wrongWords); // 保存错误单词

        // 检查是否是已掌握单词的重新测试
        if (masteredWordsInTest.includes(word)) {
            // 已掌握单词测试错误，将其移回常规单词列表
            const masteredWordIndex = masteredWords.findIndex(item => item.word === word);
            if (masteredWordIndex !== -1) {
                masteredWords.splice(masteredWordIndex, 1); // 从已掌握列表中移除
                words.push(word); // 加入常规单词列表
                saveWords(); // 保存更新后的words列表
                correctStreaks[word] = 0; // 重置连续正确次数
                saveStreaks();
                document.getElementById('result').innerHTML += '<span style="color:red;">（已移回常规学习列表）</span>';
            }
        } else {
            // 常规单词答错，连续正确计数清零
            correctStreaks[word] = 0;
            saveStreaks(); // 保存 streak 变化
        }
    }
    updateSummary(); // 更新统计显示
    
    // 自动同步数据到Gist
    autoSyncToGist();
    
    current++;
    setTimeout(() => {
        if (current < shuffledWords.length) {
            nextWord();
        } else {
            endDictation();
        }
    }, 600);
}

document.getElementById('wordInput').addEventListener('input', function(e) {
    if (document.getElementById('result').textContent !== '') {
        document.getElementById('result').textContent = '';
    }
});

// 重听按钮功能
document.getElementById('repeatBtn').onclick = function() {
    if (isStarted && current < shuffledWords.length) {
        speakWord(shuffledWords[current]);
    }
};

function endDictation() {
    isStarted = false;
    document.getElementById('dictationArea').style.display = 'none';
    document.getElementById('startBtn').style.display = '';
    updateSummary();
}

document.getElementById('startBtn').onclick = startDictation;
document.getElementById('wordInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') submitAnswer();
});



// 保存数据到Gist（包含历史数据）
async function saveToGistWithHistory(data) {
    if (!githubConfig.token) {
        throw new Error('GitHub token 未配置');
    }

    // 清理历史数据（保留3天内的记录）
    const cleanedHistoryData = cleanOldHistoryData(data.historyData || {});
    
    const gistData = {
        description: "单词听写数据",
        public: false,
        files: {
            "words.txt": {
                content: data.words.join('\n')
            },
            "data.json": {
                content: JSON.stringify({
                    correctStreaks: data.correctStreaks || {},
                    masteredWords: data.masteredWords || [],
                    todayRecords: {
                        date: getTodayStr(),
                        doneWords: data.todayDoneWords || [],
                        wrongWords: data.todayWrongWords || [],
                        attempts: data.todayAttempts || 0,
                        attemptedWords: Array.from(data.todayAttemptedWords || [])
                    },
                    historyData: cleanedHistoryData // 清理后的历史数据
                }, null, 2)
            }
        }
    };

    let url = githubConfig.gistId 
        ? `https://api.github.com/gists/${githubConfig.gistId}`
        : 'https://api.github.com/gists';
    
    let method = githubConfig.gistId ? 'PATCH' : 'POST';

    let response = await fetch(url, {
        method: method,
        headers: {
            'Authorization': `token ${githubConfig.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(gistData)
    });

    // 如果是404错误（Gist不存在），则创建新的Gist
    if (response.status === 404 && githubConfig.gistId) {
        console.log('原Gist不存在，创建新的Gist...');
        url = 'https://api.github.com/gists';
        method = 'POST';
        
        response = await fetch(url, {
            method: method,
            headers: {
                'Authorization': `token ${githubConfig.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gistData)
        });
    }

    if (!response.ok) {
        const errorText = await response.text();
        console.error('GitHub API 错误详情:', {
            status: response.status,
            statusText: response.statusText,
            url: url,
            method: method,
            response: errorText
        });
        throw new Error(`GitHub API 错误: ${response.status} ${response.statusText}\n详情: ${errorText}`);
    }

    const result = await response.json();
    
    // 如果是新创建的Gist，更新ID并记录
    if (method === 'POST') {
        const oldGistId = githubConfig.gistId;
        githubConfig.gistId = result.id;
        console.log('新创建的 Gist ID:', result.id);
        
        if (oldGistId) {
            console.log(`原Gist不存在，已创建新的 Gist，ID: ${result.id}`);
        } else {
            console.log(`已创建新的 Gist，ID: ${result.id}`);
        }
    }
    
    return result;
}


// 显示绿色成功提示
function showSuccessMessage(message, duration = 3000) {
    const messageDiv = document.getElementById('successMessage');
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    
    // 自动隐藏
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, duration);
}

// 显示红色错误警告
function showErrorMessage(message, duration = 5000) {
    const messageDiv = document.getElementById('errorMessage');
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    
    // 自动隐藏
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, duration);
}

// 自动同步到Gist（静默）
async function autoSyncToGist() {
    if (!githubConfig.token || !githubConfig.gistId) {
        console.log('GitHub配置不完整，跳过自动同步');
        return;
    }
    
    try {
        // 收集现有的历史数据（从localStorage）
        const existingHistoryData = {};
        
        // 扫描localStorage中的历史记录
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.startsWith('dictation_done_') || 
                       key.startsWith('dictation_wrong_') || 
                       key.startsWith('dictation_attempts_') ||
                       key.startsWith('dictation_attempted_'))) {
                
                const dateMatch = key.match(/_(\d{4}-\d+-\d+)$/);
                if (dateMatch) {
                    const date = dateMatch[1];
                    if (!existingHistoryData[date]) {
                        existingHistoryData[date] = {};
                    }
                    
                    if (key.includes('_done_')) {
                        existingHistoryData[date].doneWords = JSON.parse(localStorage.getItem(key) || '[]');
                    } else if (key.includes('_wrong_')) {
                        existingHistoryData[date].wrongWords = JSON.parse(localStorage.getItem(key) || '[]');
                    } else if (key.includes('_attempts_')) {
                        existingHistoryData[date].attempts = JSON.parse(localStorage.getItem(key) || '0');
                    } else if (key.includes('_attempted_')) {
                        existingHistoryData[date].attemptedWords = JSON.parse(localStorage.getItem(key) || '[]');
                    }
                }
            }
        }
        
        // 准备同步数据
        const syncData = {
            words: words,
            correctStreaks: correctStreaks,
            masteredWords: masteredWords,
            todayDoneWords: getTodayDoneWords(),
            todayWrongWords: wrongWords,
            todayAttempts: todayAttempts,
            todayAttemptedWords: todayAttemptedWords,
            historyData: existingHistoryData
        };
        
        // 静默同步到Gist
        await saveToGist(syncData);
        console.log('自动同步成功');
        
    } catch (error) {
        console.error('自动同步失败:', error);
        // 静默失败，不影响用户体验
    }
}

// 折叠/展开添加新词功能
document.getElementById('toggleAddWordBtn').addEventListener('click', function() {
    const panel = document.getElementById('addWordPanel');
    const icon = document.getElementById('toggleIcon');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        icon.textContent = '▼';
        // 展开时自动聚焦到输入框
        setTimeout(() => {
            document.getElementById('newWordInput').focus();
        }, 100);
    } else {
        panel.style.display = 'none';
        icon.textContent = '▶';
        // 折叠时清空输入框
        document.getElementById('newWordInput').value = '';
    }
});


// 添加新词功能
document.getElementById('addWordBtn').addEventListener('click', function() {
    const newWord = document.getElementById('newWordInput').value.trim();
    
    if (!newWord) {
        alert('请输入要添加的单词');
        return;
    }
    
    // 检查单词是否已存在
    if (words.includes(newWord)) {
        alert('该单词已存在于列表中');
        return;
    }
    
    // 检查单词是否在已掌握列表中
    if (masteredWords.some(item => item.word === newWord)) {
        alert('该单词已在已掌握列表中');
        return;
    }
    
    // 添加到单词列表
    words.push(newWord);
    saveWords(); // 保存到本地存储
    
    // 清空输入框并折叠面板
    document.getElementById('newWordInput').value = '';
    const panel = document.getElementById('addWordPanel');
    const icon = document.getElementById('toggleIcon');
    panel.style.display = 'none';
    icon.textContent = '▶';
    
    // 更新界面显示
    document.getElementById('startBtn').disabled = false;
    document.getElementById('summary').textContent = `当前单词列表有 ${words.length} 个单词。`;
    
    // 显示绿色成功提示
    showSuccessMessage(`✓ 成功添加单词: ${newWord}`);
    
    // 自动同步到Gist
    autoSyncToGist();
});

// 测试新词发音功能
document.getElementById('testNewWordBtn').addEventListener('click', function() {
    const newWord = document.getElementById('newWordInput').value.trim();
    
    if (!newWord) {
        alert('请先输入要测试的单词');
        return;
    }
    
    speakWord(newWord);
});

// 新词输入框回车键支持
document.getElementById('newWordInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('addWordBtn').click();
    }
});

// GitHub配置相关事件处理
document.getElementById('saveConfigBtn').addEventListener('click', function() {
    const token = document.getElementById('tokenInput').value.trim();
    const gistId = document.getElementById('gistIdInput').value.trim();
    
    if (!token || !gistId) {
        showErrorMessage('请填写完整的Token和Gist ID');
        return;
    }
    
    // 验证token格式（GitHub token通常以ghp_开头）
    if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
        showErrorMessage('Token格式可能不正确，GitHub Personal Access Token通常以ghp_开头');
        return;
    }
    
    // 保存配置
    if (saveGitHubConfig(token, gistId)) {
        // 更新全局配置
        githubConfig.token = token;
        githubConfig.gistId = gistId;
        
        showSuccessMessage('✓ GitHub配置保存成功！');
        
        // 隐藏配置面板
        document.getElementById('configPanel').style.display = 'none';
        
        // 清空输入框
        document.getElementById('tokenInput').value = '';
        document.getElementById('gistIdInput').value = '';
        
        // 尝试加载数据
        loadDataFromGist();
    } else {
        showErrorMessage('配置保存失败，请重试');
    }
});

// 测试配置连接
document.getElementById('testConfigBtn').addEventListener('click', async function() {
    const token = document.getElementById('tokenInput').value.trim();
    const gistId = document.getElementById('gistIdInput').value.trim();
    
    if (!token || !gistId) {
        showErrorMessage('请先填写Token和Gist ID');
        return;
    }
    
    this.textContent = '测试中...';
    this.disabled = true;
    
    try {
        const response = await fetch(`https://api.github.com/gists/${gistId}`, {
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            showSuccessMessage('✓ 连接测试成功！');
        } else {
            showErrorMessage(`连接测试失败：${response.status} ${response.statusText}`);
        }
    } catch (error) {
        showErrorMessage(`连接测试失败：${error.message}`);
    }
    
    this.textContent = '测试连接';
    this.disabled = false;
});

// 显示配置面板
function showConfigPanel() {
    document.getElementById('configPanel').style.display = 'block';
    setTimeout(() => {
        document.getElementById('tokenInput').focus();
    }, 100);
}




// 从 Gist 加载数据的功能
async function loadDataFromGist() {
    if (!githubConfig.token || !githubConfig.gistId) {
        return false;
    }
    
    try {
        const data = await loadFromGist();
        
        // 应用加载的数据
        words = data.words;
        correctStreaks = data.correctStreaks;
        masteredWords = data.masteredWords;
        
        // 为旧的已掌握单词添加lastTestDate字段（如果没有的话）
        masteredWords.forEach(item => {
            if (!item.lastTestDate) {
                item.lastTestDate = item.masteredDate; // 使用掌握日期作为初始测试日期
            }
        });
        wrongWords = data.todayWrongWords;
        todayAttempts = data.todayAttempts;
        todayAttemptedWords = new Set(data.todayAttemptedWords);
        
        // 更新界面
        if (words.length > 0) {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('summary').textContent = `从 Gist 加载了 ${words.length} 个单词。`;
        }
        
        updateSummary();
        return true;
        
    } catch (error) {
        console.error('从 Gist 加载数据失败:', error);
        return false;
    }
}


// 页面加载时恢复数据
window.addEventListener('load', async function() {
    
    // 清理本地过期的历史数据
    cleanLocalStorageHistory();
    
    // 检查是否已有配置
    if (hasValidConfig()) {
        // 从localStorage加载配置
        const config = loadGitHubConfig();
        githubConfig.token = config.token;
        githubConfig.gistId = config.gistId;
        
        console.log('使用已保存的GitHub配置');
        
        // 尝试从 Gist 加载数据
        const gistLoaded = await loadDataFromGist();
        
        if (!gistLoaded) {
            // 显示Gist加载失败的警告
            showErrorMessage('⚠️ Gist数据加载失败，已切换到本地缓存模式。');
            
            // 从本地存储恢复基本数据
            loadLocalData();
        }
    } else {
        // 没有配置，显示配置面板
        console.log('未找到GitHub配置，显示配置面板');
        showConfigPanel();
        document.getElementById('summary').textContent = "请先配置GitHub信息以同步数据。";
        
        // 同时尝试加载本地数据
        loadLocalData();
    }
});

// 加载本地数据的函数
function loadLocalData() {
    wrongWords = getTodayWrongWords();
    todayAttempts = getTodayAttempts();
    todayAttemptedWords = getTodayAttemptedWords();

    // 恢复本地保存的单词列表和学习进度
    const savedWords = localStorage.getItem('dictation_words');
    if (savedWords) {
        words = JSON.parse(savedWords);
        if (words.length > 0) {
            document.getElementById('startBtn').disabled = false;
            if (document.getElementById('summary').textContent.includes('请先配置')) {
                document.getElementById('summary').textContent = `找到本地缓存的 ${words.length} 个单词，建议配置GitHub以同步最新数据。`;
            } else {
                document.getElementById('summary').textContent = `从本地缓存加载了 ${words.length} 个单词。`;
            }
        }
    }

    const savedStreaks = localStorage.getItem('dictation_streaks');
    if (savedStreaks) {
        correctStreaks = JSON.parse(savedStreaks);
    }

    updateSummary();
    
    // 如果没有任何数据且没有配置，提示用户
    if (words.length === 0 && !hasValidConfig()) {
        document.getElementById('startBtn').disabled = true;
        document.getElementById('summary').textContent = "请配置GitHub信息以开始使用。";
    }
}
    </script>
</body>
</html>